name: Generate OSM Speed Tiles (Offline PBF)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Install npm dependencies
      - name: Install npm packages
        run: npm install

      # 4️⃣ Install osmium-tool (from official Ubuntu repo)
      # 4️⃣ Install latest osmium-tool from PPA
      - name: Install osmium-tool
        run: |
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:osmcode/osmium-tool
          sudo apt-get update
          sudo apt-get install -y osmium-tool


      # 5️⃣ Download PBF
      - name: Download PBF
        run: |
          curl -L -o uk_highways_max.osm.pbf https://github.com/stevoamigo2-cmd/preprocess-osm-road-speed-limits/releases/download/v1.0.0/uk_highways_max.osm.pbf
          # If your script needs withnodes version, create it:
          cp uk_highways_max.osm.pbf uk_highways_max.withnodes.pbf

      # 5.1️⃣ Generate tiles from the PBF
      - name: Generate tiles
        run: |
          node generate_tiles_from_pbf.js uk_highways_max.withnodes.pbf

      # 6️⃣ Configure git user for commits
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 7️⃣ Commit and push generated tiles safely
      - name: Commit tiles
        run: |
          git checkout -B gh-pages || git checkout gh-pages
          if [ -f out/generate_summary.json ]; then
            git add out/generate_summary.json out/tiles
            git commit -m "Update tiles from offline PBF"
            git push origin gh-pages --force
          else
            echo "No output files to commit, skipping Git commit"
          fi
