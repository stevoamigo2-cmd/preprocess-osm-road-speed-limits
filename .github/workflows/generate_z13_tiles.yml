name: Generate Z13 Speed Tiles (matrix, no UK)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        country: [fr,de,es,it,nl,be,ie,pt,se,no,dk,ch,at,pl,cz,hu,ro,bg,gr,us,ca,au,nz]

    env:
      REPO: stevoamigo2-cmd/preprocess-osm-road-speed-limits
      TAG: v1.1.0   # release tag that contains the PBF assets

    steps:
      # -------------------------------------------------
      # Checkout repo (needed for scripts + gh-pages)
      # -------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------
      # System deps
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq build-essential libgeos-dev libxml2-dev

      # -------------------------------------------------
      # Python
      # -------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install osmium mercantile shapely pyproj

      # -------------------------------------------------
      # Country vars
      # -------------------------------------------------
      - name: Set country variables
        run: |
          echo "COUNTRY=${{ matrix.country }}" >> $GITHUB_ENV
          echo "ASSET_NAME=${{ matrix.country }}_highways_max.osm.pbf" >> $GITHUB_ENV

      # -------------------------------------------------
      # Download PBF from release
      # -------------------------------------------------
      - name: Download release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p data

          REL_JSON=$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")

          ASSET_ID=$(echo "$REL_JSON" | jq -r \
            ".assets[] | select(.name==\"${ASSET_NAME}\") | .id")

          if [ -z "$ASSET_ID" ] || [ "$ASSET_ID" = "null" ]; then
            echo "‚ùå Asset ${ASSET_NAME} not found in ${TAG}, skipping."
            exit 0
          fi

          curl --fail --location \
            -H "Accept: application/octet-stream" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${REPO}/releases/assets/${ASSET_ID}" \
            --output "data/${ASSET_NAME}"

      # -------------------------------------------------
      # Generate tiles
      # -------------------------------------------------
      - name: Generate Z13 tiles
        run: |
          mkdir -p generated_tiles
          python scripts/pbf_to_tiles.py \
            --pbf data/${ASSET_NAME} \
            --country ${COUNTRY} \
            --zoom 13 \
            --out generated_tiles/tiles
            

      # -------------------------------------------------
      # Deploy to gh-pages
      # -------------------------------------------------
      - name: Deploy tiles to GitHub Pages
        run: |
          set -e

          git fetch origin gh-pages
          git checkout gh-pages

          mkdir -p public/tiles/${COUNTRY}
          cp -r generated_tiles/tiles/${COUNTRY}/* public/tiles/${COUNTRY}/

          git add public/tiles/${COUNTRY}

          if git diff --cached --quiet; then
            echo "No changes to commit for ${COUNTRY}"
          else
            git commit -m "Add Z13 tiles for ${COUNTRY}"
            git push origin gh-pages
          fi
