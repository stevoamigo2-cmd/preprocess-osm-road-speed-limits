name: Generate Z13 Speed Tiles (matrix, no UK)

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        country: [fr,de,es,it,nl,be,ie,pt,se,no,dk,ch,at,pl,cz,hu,ro,bg,gr,us,ca,au,nz]

    env:
      REPO: stevoamigo2-cmd/preprocess-osm-road-speed-limits
      TAG: v1.0.0

    steps:
      - uses: actions/checkout@v4

      - run: sudo apt-get update && sudo apt-get install -y jq libgeos-dev

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set vars
        run: |
          echo "COUNTRY=${{ matrix.country }}" >> $GITHUB_ENV
          echo "ASSET=${{ matrix.country }}_highways_max.osm.pbf" >> $GITHUB_ENV

      - name: Download asset (skip if missing)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p data
          REL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${REPO}/releases/tags/${TAG})

          ID=$(echo "$REL" | jq -r ".assets[] | select(.name==\"$ASSET\") | .id")
          [ -z "$ID" ] && exit 0

          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            https://api.github.com/repos/${REPO}/releases/assets/$ID \
            -o data/$ASSET

      - run: pip install osmium mercantile shapely pyproj

      - name: Generate tiles
        run: |
          python scripts/pbf_to_tiles.py \
            --pbf data/$ASSET \
            --country $COUNTRY \
            --zoom 13 \
            --out generated_tiles/tiles

      - run: |
          mkdir -p public
          cp -r generated_tiles/tiles/* public/ || true

  pages:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Disable Jekyll
        run: |
          mkdir -p public
          touch public/.nojekyll

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAT }}
          publish_dir: ./public
          keep_files: true
