name: Generate Z13 Speed Tiles (matrix, no UK)

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        country: [nl] # test with pt, then add more countries

    env:
      REPO: stevoamigo2-cmd/preprocess-osm-road-speed-limits
      TAG: v1.7.0   # release tag that contains the PBF assets

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq build-essential libgeos-dev libxml2-dev

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install osmium mercantile shapely pyproj

      - name: Set country variables
        run: |
          echo "COUNTRY=${{ matrix.country }}" >> $GITHUB_ENV
          echo "ASSET_NAME=${{ matrix.country }}_highways_max.osm.pbf" >> $GITHUB_ENV

      - name: Download release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p data
          REL_JSON=$(curl -sS -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")

          ASSET_ID=$(echo "$REL_JSON" | jq -r ".assets[] | select(.name==\"${ASSET_NAME}\") | .id")
          if [ -z "$ASSET_ID" ] || [ "$ASSET_ID" = "null" ]; then
            echo "Asset ${ASSET_NAME} not found in ${TAG}, skipping."
            exit 0
          fi

          curl --fail --location \
            -H "Accept: application/octet-stream" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${REPO}/releases/assets/${ASSET_ID}" \
            --output "data/${ASSET_NAME}"
          echo "Downloaded to data/${ASSET_NAME}"

      - name: Generate Z13 tiles
        run: |
          mkdir -p generated_tiles
          python scripts/pbf_to_tiles.py \
            --pbf data/${ASSET_NAME} \
            --country ${COUNTRY} \
            --zoom 13 \
            --out generated_tiles/tiles
          echo "Generator finished for ${COUNTRY}"

      # --- Deploy using actions-gh-pages (more reliable than manual git push) ---
      - name: Prepare public folder
        run: |
          # make sure public exists
          mkdir -p public
          # safe copy: copy contents (including hidden) from source dir into dest
          mkdir -p public/tiles/${COUNTRY}
          # The cp source/. dest/ pattern copies everything without failing on empty
          cp -a generated_tiles/tiles/${COUNTRY}/. public/tiles/${COUNTRY}/ || true

          # debug listing so logs show what's being published
          echo "Listing public/tiles/${COUNTRY} (top levels):"
          ls -la public/tiles/${COUNTRY} || true
          echo "Count files (3 levels):"
          find public/tiles/${COUNTRY} -type f | wc -l || true

          # ensure nojekyll present
          touch public/.nojekyll

      - name: Publish to GitHub Pages (peaceiris)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAT }}   # recommended: create GH_PAT with repo + pages permissions
          publish_dir: ./public
          keep_files: true
